<!DOCTYPE html>
<html>
<head>    
	<title>Codifyr - compiler</title>    
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />    
	<script src="/_utils/script/json2.js"></script>    
	<script src="/_utils/script/sha1.js"></script>    
	<script src="/_utils/script/jquery.js?1.4.2"></script>    
	<script src="/_utils/script/jquery.couch.js?0.11.0"></script>    
	<script src="/_utils/script/jquery.dialog.js?0.11.0"></script>    
	<style type="text/css">
	        .level_0 {background-color:lightyellow;} 
	        .level_n1 {background-color:lightcoral;}        
	        .level_1 {background-color:lightgreen;}    
	</style>
</head>
    <body>    
    	<center>        
			<br><br>Updating ...<br><br>
			<div id="logger"></div>
			<br><br>        
			<a href="#" onclick="openPreview()">open preview</a>    
    	</center>    
    <script>    
    /* Running tests we can 
    	1. edit the upload file through CodifyR 
    	2. send to a couchdb
    	3. open the file (assuming database name is 'dta')
    		http://54.249.201.191/dta/_design/preview/uploader.html
    	4. uncomment the code bellow (which will automatically run an upload of following files)
    Test data: */
    
    	test_file_png = {"name":"file.png", "content_type":"text/png", "content": "data:image/png;base64,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"};
    	test_file_txt = {"name":"file.txt", "content_type":"text/png", "content": "contenst for txt"};
    	test_file_js = {"name":"file.js", "content_type":"text/javascript", "content": "contenst for javascript"};
    	test_files = [test_file_png, test_file_txt, test_file_js];
    	test_document = {"ddoc": {"_id": "_design/preview"}, "database": "dta", "files": test_files}
    	setTimeout(function(){handleMessage(test_document)}, 1000);
    /**/
    
	    addEventListener("message", function(e) { 
	    	handleMessage(JSON.parse(e.data));
	    }, false);

	    function handleMessage(data) {        
	    	var username = data.username;        
	    	var password = data.password;        
	    	preview_file = data.preview;        
	    	database = data.database;        
	    	ddoc = data.ddoc;        
	    	files = data.files;        
	    	if (username){            
	    		$.couch.login({
		    			name: username, 
		    			password: password, 
		    			success: function(data) {                    
		    				log("Login successfull with " + username + " " + JSON.stringify(data), 1, "CouchDB Compiler");                    
		    				updateDocument(ddoc, database, function() {                        
		    					updateAttachments(database, ddoc._id, files);                    
		    				});                
			    		},
			    		error: function(status) {                    
			    			log("Login failed with " + username + " " + JSON.stringify(status), -1, "CouchDB Compiler");                    
			    			$.couch.info({success: function(data) {                            
			    				log("Server used is " + JSON.stringify(data), 1, "CouchDB Compiler");                        
			    			}
		    			});                
					}            
		    	});                
		    } else {            
		    	updateDocument(ddoc, database, function() {                
		    		updateAttachments(database, ddoc._id, files);            
		    	});        
		    }    
		}
		/*a = {"files":[{"name":"file-name.js", "content":"contenst for js", "content_type":"text/html"}], "document":{"_id": "_design/preview", "mydata":"value"}} sessionStorage.setItem("compiled_couchdb", JSON.stringify(a))*/        

		function updateDocument(ddoc, db_name, fn_update_attachments) {        
			var doc = ddoc;        
			var db = $.couch.db(db_name);        
			db.openDoc(doc._id, {success: function(old_doc) {                
				var ftime = new Date().getTime();                
				log("Design document fetched ", 0, "CouchDB Compiler", ftime);                
				doc._rev = old_doc._rev;
				doc._attachments = JSON.parse(JSON.stringify(old_doc._attachments));
				db.saveDoc(doc, {success: function(new_doc) {                        
					log("Design document updated ", 1, "CouchDB Compiler", ftime);                        
					fn_update_attachments();                    
				},error: function(status) {                        
					log("Design document failed update " + JSON.stringify(status), -1, "CouchDB Compiler", ftime);                    
				}});            
			},error: function(status) {                
				var ftime = new Date().getTime();                
				db.saveDoc(doc, {success: function(data) {                        
					log("Design document created ", 0, "CouchDB Compiler", ftime);                        
					fn_update_attachments();                    
				},error: function(status) {                        
					log("Design document failed creation ", -1, "CouchDB Compiler");                    
				}});            
			}});    
		};    
		function updateAttachments(database, document_id, files) {        
			window.file_index = 0;        
			var f = files[window.file_index];        
			uploadFile(database, document_id, f.name, f.content_type, f.content);    
		};    

		var uploadFile = function(database_name, document_id, file_name, file_type, file_content) {        
			var ftime = new Date().getTime();        
			log("Fetching " + file_name, 0, "CouchDB Compiler", ftime);        
			var baseUrl = "/" + database_name + "/";        
			var name = encodeURIComponent(file_name), type = file_type, fileReader = new FileReader(), getRequest = new XMLHttpRequest(), putRequest = new XMLHttpRequest();        
			var url = baseUrl + document_id;        
			log("Document attachment using URL " + url, 0, "CouchDB Compiler");        
			getRequest.open("GET", url, true);        
			getRequest.send();        
			
			getRequest.onreadystatechange = function(response) {            
				var fftime = ftime;            
				if (getRequest.readyState == 4 && getRequest.status == 200) {                
					log("Updating " + file_name, 0, "CouchDB Compiler");                
					var doc = JSON.parse(getRequest.responseText);                
					putRequest.open("PUT", baseUrl + encodeURIComponent(document_id) + "/" + name + "?rev=" + doc._rev, true);                
					putRequest.setRequestHeader("Content-Type", type);                
					putRequest.send(file_content);                
					putRequest.onreadystatechange = function(response) {                    
						if (putRequest.readyState == 4) {                        
							console.log(putRequest);                        
							log("Updated " + file_name, 1, "CouchDB Compiler", ftime);                        
							window.file_index = window.file_index + 1;                        
							if (files.length > window.file_index){                            
								var f = files[window.file_index];                            
								uploadFile(database, document_id, f.name, f.content_type, f.content);                        
							}                    
						}                
					};            
				}            
				if (getRequest.readyState == 4 && getRequest.status == 409) {                
					log("Failed " + file_name, -1, "CouchDB Compiler", ftime);            
				}        
			};    
		};    

		function log(msg, level, title, state_id) {        
			console.info(msg);        
			if (document.editor) {            
				document.editor.consoleOutput({"message": msg, "level": level, "title": title});        
			}        
			if (state_id) {            
				var d = $("#" + state_id);            
				if (d.length) {                
					d.html(msg);            
				} else {                
					d = $("#logger").append("<div id=" + state_id + ">" + msg + "</div>");            
				}            
				if (level ==-1){ d.addClass("level_n1"); }            
				if (level == 0){ d.addClass("level_0"); }            
				if (level == 1){ d.addClass("level_1"); }        
			}    
		}    
		function openPreview() {        
			location.href = preview_file;    
		} /* test data */    
	</script>
</body>
</html>  